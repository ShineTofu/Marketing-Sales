<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Suite — Unified (BA payment style)</title>
  <meta name="description" content="Unified app: BA payment + Marketing sales. One visual, XLSX-only export." />

  <!-- ====== Base styles copied from BA payment to preserve exact look ====== -->
  <style>
    :root {
      --beige: #f6f3dd;
      --green: #028b43;
      --orange: #f8a925;
      --bg: var(--beige);
      --text: #0b1220;
      --muted: #475569;
      --card: #ffffff;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; background: var(--bg); color: var(--text); }
    a { color: var(--green); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { width: min(1100px, 94%); margin: 0 auto; }
    header { position: sticky; top: 0; backdrop-filter: blur(6px); background: color-mix(in oklab, var(--beige) 65%, #fff 35%); border-bottom: 1px solid var(--border); z-index: 10; }
    .nav { display:flex; align-items:center; justify-content:space-between; padding: 14px 0; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:800; }
    .logo { width: 30px; height: 30px; border-radius: 10px; background: var(--green); color: #fff; display:grid; place-items:center; font-weight:900; }
    .menu { display:flex; gap:16px; color: var(--muted); }

    main { padding: 26px 0; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: 0 6px 20px rgba(2,139,67,0.06); }
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .span-12 { grid-column: span 12; }
    .span-6 { grid-column: span 12; }
    @media (min-width: 860px){ .span-6{ grid-column: span 6; } }

    h1 { font-size: clamp(28px, 4vw, 40px); margin: 10px 0 0; }
    h2 { font-size: 20px; margin: 0 0 12px; }
    h3 { font-size: 16px; margin: 6px 0 10px; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; }

    .hero { padding: 28px 0 10px; }
    .eyebrow { color: var(--muted); font-weight: 700; letter-spacing: .12em; text-transform: uppercase; font-size: 12px; }
    .cta { margin-top: 14px; display:flex; gap:10px; flex-wrap: wrap; }

    .btn { border: 1px solid var(--border); background: #fff; color: var(--text); padding: 10px 16px; border-radius: 12px; font-weight: 700; cursor: pointer; }
    .btn.primary { background: var(--green); color: #fff; border-color: transparent; }
    .btn.warn { background: var(--orange); color:#222; border-color: transparent; }
    .pill { border-radius: 999px; padding: 6px 10px; background: #fef3c7; color: #92400e; font-weight: 700; font-size: 12px; }

    form .row { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; margin-bottom: 12px; }
    label { font-size: 12px; color: var(--muted); font-weight: 700; letter-spacing:.02em; }
    input, select { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); background: #fff; color: var(--text); font-size: 14px; }
    input[readonly] { background: #f8fafc; color:#475569; }

    .kpi { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .kpi .tile { grid-column: span 12; border:1px dashed var(--border); border-radius: 16px; padding: 14px; background: #fff; }
    .kpi .value { font-size: 22px; font-weight: 800; }
    .kpi .caption { color: var(--muted); font-size: 12px; }
    @media (min-width: 860px){ .kpi .tile.sm-4{ grid-column: span 4; } }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--border); text-align: left; padding: 8px; font-size: 13px; }
    thead th { position: sticky; top: 0; background: #fff8ee; z-index: 1; }
    tbody tr:hover { background: #f9fafb; }

    footer { border-top: 1px solid var(--border); color: var(--muted); padding: 18px 0 40px; font-size: 14px; }

    /* helper */
    .hidden{ display:none !important; }
    .subnote{ color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <!-- ===== Header (BA payment look) ===== -->
  <header>
    <div class="container nav">
      <div class="brand">
        <div class="logo" aria-hidden="true">BA</div>
        <span class="app-logo-text">Sales</span> Sales Suite — BA look. | <a id="source-link" href="#">Source code</a>
      </small>
    </div>
  </footer>

  <!-- ===== XLSX lib (for both flows) ===== -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ======= COMMON: init header/footer =======
    document.getElementById('year').textContent = new Date().getFullYear();
    document.getElementById('source-link').href = '#';

    // ======= COMMON: selector logic & routing =======
    const selDate = document.getElementById('sel-date');
    const selChannel = document.getElementById('sel-channel');
    const selDistrict = document.getElementById('sel-district');
    const selectorCard = document.getElementById('selector');
    const app1 = document.getElementById('app1');
    const app2 = document.getElementById('app2');

    function todayISO(){
      const d=new Date();
      const tz=new Date(d.getTime()-d.getTimezoneOffset()*60000);
      return tz.toISOString().slice(0,10);
    }
    selDate.value = todayISO();

    function routeTarget(channel){
      if(channel==='Hawking' || channel==='Market') return 'app1';
      if(channel==='School' || channel==='D2C' || channel==='B2E') return 'app2';
      return null;
    }

    function showSection(which){
      app1.classList.toggle('hidden', which!=='app1');
      app2.classList.toggle('hidden', which!=='app2');
      selectorCard.classList.toggle('hidden', true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Map external channel -> BA select value
    const BA_CHANNEL_MAP = { 'Market':'Market sales', 'Hawking':'Hawking' };

    document.getElementById('selector-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const dt = selDate.value; const ch = selChannel.value; const dist = selDistrict.value;
      const tgt = routeTarget(ch);
      if(!dt || !tgt || !dist){ alert('Please select Date, Sales channel and District.'); return; }

      if(tgt==='app1'){
        // Lock banners
        document.getElementById('bp-locked-date').value = dt;
        document.getElementById('bp-locked-channel').value = BA_CHANNEL_MAP[ch] || '';
        document.getElementById('bp-locked-district').value = dist;
        // Fill real form fields and lock them
        const bpDate = document.getElementById('date');
        const bpChannel = document.getElementById('channel');
        const bpDistrict = document.getElementById('bp-district');
        if (bpDate){ bpDate.value = dt; bpDate.readOnly = true; }
        if (bpChannel){ bpChannel.value = BA_CHANNEL_MAP[ch] || ''; bpChannel.disabled = true; ['change','input'].forEach(ev=>bpChannel.dispatchEvent(new Event(ev))); }
        if (bpDistrict){ bpDistrict.value = dist; bpDistrict.disabled = true; }
        showSection('app1');
      } else {
        // Marketing: lock banners
        document.getElementById('ms-locked-date').value = dt;
        const msLockedCh = document.getElementById('ms-locked-channel');
        if ([...msLockedCh.options].some(o=>o.value===ch)) { msLockedCh.value = ch; }
        else { msLockedCh.insertAdjacentHTML('beforeend', `<option value="${ch}">${ch}</option>`); msLockedCh.value = ch; }
        const msLockedDist = document.getElementById('ms-locked-district');
        msLockedDist.value = dist;
        // Fill real form fields and lock date + district
        const msDate = document.getElementById('ms-date');
        if (msDate){ msDate.value = dt; msDate.readOnly = true; }
        const msDistrict = document.getElementById('ms-district');
        if (msDistrict){ msDistrict.value = dist; msDistrict.disabled = true; }
        showSection('app2');
      }
    });

    // ======= BA PAYMENT: original logic (unchanged except District support) =======
    (function BA_Payment(){
      // Helpers
      const UGX = (n) => (isFinite(n) ? Math.round(Number(n)) : 0);
      const KG3 = (n) => (isFinite(n) ? Number(n).toFixed(3) : (0).toFixed(3));
      const num = (n) => (n === '' || n === null || n === undefined ? 0 : Number(n));

      const defaults = { Kikalayi: { price: 500,  weight: 0.03 }, Skewers: { price: 1000, weight: 0.045 }, };

      const el = (id) => document.getElementById(id);
      const product = el('product');
      const unitPrice = el('unitPrice');
      const portionWeight = el('portionWeight');
      const issuedPortions = el('issuedPortions');
      const issuedKg = el('issuedKg');
      const closingPortions = el('closingPortions');
      const closingKg = el('closingKg');
      const actualSales = el('actualSales');
      const cash = el('cash');
      const flatRate = el('flatRate');
      const commissionRate = el('commissionRate');
      const marketFees = el('marketFees');
      const advancedMarketFees = el('advancedMarketFees');
      const bpDistrict = el('bp-district');

      const kpiDis = el('kpi-discrepancy');
      const kpiCom = el('kpi-commission');
      const kpiTotal = el('kpi-total');

      const form = el('sales-form');
      const tbody = el('tbody');

      const STORAGE_KEY = 'ba_payment_records_v1_3'; // bumped for district field
      const loadRecords = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const saveRecords = (rows) => localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));

      const getDefaultsFor = (name) => {
        const key = String(name || '').toLowerCase().trim();
        if (key.startsWith('kikal')) return defaults.Kikalayi;
        if (key.startsWith('skewer')) return defaults.Skewers;
        return null;
      };

      const applyProductDefaults = () => {
        const val = (product.value || '').trim();
        if (!val) { unitPrice.value = 0; portionWeight.value = 0; }
        else { const d = getDefaultsFor(val) || defaults.Kikalayi; unitPrice.value = d.price; portionWeight.value = d.weight; }
        compute();
      };

      function applyChannelDefaults(){
        const ch = el('channel').value;
        if (ch === 'Market sales') { flatRate.value = 5000; commissionRate.value = 20; }
        else if (ch === 'Hawking') { flatRate.value = 0; commissionRate.value = 20; }
        else if (ch === '') { flatRate.value = 0; commissionRate.value = 0; }
        compute();
      }

      document.addEventListener('wheel', (e) => {
        const t = e.target; if (t && t.tagName === 'INPUT' && t.type === 'number') { t.blur(); }
      }, { passive: true });

      function isFeesOnlyMode(){ return num(marketFees.value) > 0 || num(advancedMarketFees.value) > 0; }

      function updateRequired(){
        const feesOnly = isFeesOnlyMode();
        el('date').required = true;
        const requiredIds = [ 'channel','product','sa','area','bp-district','unitPrice','portionWeight','issuedPortions','closingPortions','cash','commissionRate','flatRate' ];
        requiredIds.forEach(id => { const node = el(id); if (!node) return; node.required = !feesOnly; });
      }

      let warnedCashOver = false;

      const compute = () => {
        const w = num(portionWeight.value);
        const issuedP = num(issuedPortions.value);
        const closingP = num(closingPortions.value);
        const price = num(unitPrice.value);

        const issuedK = issuedP * w;
        const closingK = closingP * w;

        issuedKg.value = KG3(issuedK);
        closingKg.value = KG3(closingK);

        const actual = (issuedP - closingP) * price;
        actualSales.value = UGX(actual);

        const ch = el('channel').value;
        const effectiveRate = (ch === '' ? 0 : num(commissionRate.value));
        const flatVal      = (ch === '' ? 0 : UGX(num(flatRate.value)));

        const discrepancy = UGX(actual) - UGX(num(cash.value));
        const commission  = UGX((effectiveRate / 100) * UGX(actual));
        const totalToPay  = UGX(flatVal + commission - discrepancy);

        kpiDis.textContent   = UGX(discrepancy).toLocaleString();
        kpiCom.textContent   = UGX(commission).toLocaleString();
        kpiTotal.textContent = UGX(totalToPay).toLocaleString();

        if (discrepancy < 0) {
          if (!warnedCashOver) { alert(`Warning: Cash collected exceeds computed sales by ${Math.abs(discrepancy).toLocaleString()} UGX.`); warnedCashOver = true; }
        } else { warnedCashOver = false; }
      };

      function setTodaySafe() {
        const d = el('date');
        try { d.valueAsDate = new Date(); } catch { d.value = new Date().toISOString().slice(0,10); }
      }

      (function init(){
        // Defaults on initial page load; real locking happens after selector submit
        commissionRate.value = 20; flatRate.value = 5000; setTodaySafe(); applyChannelDefaults(); applyProductDefaults(); compute(); renderTable(); updateRequired();
      })();

      ['input','change'].forEach(evt => {
        [product, portionWeight, issuedPortions, closingPortions, unitPrice, cash, commissionRate, flatRate]
          .forEach(x => x.addEventListener(evt, compute));
      });
      ['change','input'].forEach(evt => product.addEventListener(evt, applyProductDefaults));
      ['change','input'].forEach(evt => el('channel').addEventListener(evt, applyChannelDefaults));
      [marketFees, advancedMarketFees].forEach(x => { x.addEventListener('input', updateRequired); x.addEventListener('change', updateRequired); });

      function collectFormData(){
        const date = el('date').value;
        const channel = el('channel').value;
        const prod = product.value;
        const sa = el('sa').value;
        const area = el('area').value;
        const district = (bpDistrict && bpDistrict.value) || '';
        const price = UGX(num(unitPrice.value));
        const weight = Number(num(portionWeight.value).toFixed(3));
        const issuedP = UGX(num(issuedPortions.value));
        const issuedK = Number((num(issuedPortions.value) * num(portionWeight.value)).toFixed(3));
        const closingP = UGX(num(closingPortions.value));
        const closingK = Number((num(closingPortions.value) * num(portionWeight.value)).toFixed(3));
        const cashCollected = UGX(num(cash.value));
        const actual = UGX((num(issuedPortions.value) - num(closingPortions.value)) * num(unitPrice.value));
        const effectiveRate = (channel === '' ? 0 : Number(num(commissionRate.value)));
        const commission = UGX((effectiveRate/100) * actual);
        const flat = (channel === '' ? 0 : UGX(num(flatRate.value)));
        const discrepancy = UGX(actual - cashCollected);
        const totalToPay  = UGX(flat + commission - discrepancy);
        const mFees = UGX(num(marketFees.value));
        const aFees = UGX(num(advancedMarketFees.value));
        return { date, channel, prod, sa, area, district, price, weight, issuedP, issuedK, closingP, closingK, cashCollected, actual, discrepancy, rate: effectiveRate, commission, flat, totalToPay, marketFees: mFees, advancedMarketFees: aFees };
      }

      function renderTable(){
        const rows = loadRecords();
        tbody.innerHTML = '';
        rows.forEach((r, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.date||''}</td>
            <td>${r.channel||''}</td>
            <td>${r.prod||''}</td>
            <td>${r.sa||''}</td>
            <td>${r.area||''}</td>
            <td>${r.district||''}</td>
            <td>${(r.price||0).toLocaleString()}</td>
            <td>${((r.weight??0)).toFixed(3)}</td>
            <td>${r.issuedP||0}</td>
            <td>${((r.issuedK??0)).toFixed(3)}</td>
            <td>${r.closingP||0}</td>
            <td>${((r.closingK??0)).toFixed(3)}</td>
            <td>${(r.cashCollected||0).toLocaleString()}</td>
            <td>${(r.actual||0).toLocaleString()}</td>
            <td>${(r.discrepancy||0).toLocaleString()}</td>
            <td>${(r.rate != null && r.rate !== '' ? r.rate + '%' : '0%')}</td>
            <td>${(r.commission||0).toLocaleString()}</td>
            <td>${(r.flat||0).toLocaleString()}</td>
            <td>${(r.totalToPay||0).toLocaleString()}</td>
            <td>${(r.marketFees||0).toLocaleString()}</td>
            <td>${(r.advancedMarketFees||0).toLocaleString()}</td>
            <td><button class="btn" data-del="${idx}">Delete</button></td>`;
          tbody.appendChild(tr);
        });
      }

      tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-del]'); if(!btn) return;
        const idx = Number(btn.dataset.del);
        const rows = loadRecords(); rows.splice(idx, 1); saveRecords(rows); renderTable();
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if(!ensureRequired()) return;
        compute();
        const row = collectFormData();
        const rows = loadRecords(); rows.unshift(row); saveRecords(rows); renderTable();
        form.reset(); setTodaySafe(); commissionRate.value = 20; flatRate.value = 5000; applyChannelDefaults(); applyProductDefaults(); compute(); updateRequired();
      });

      function ensureRequired(){
        if (!el('date').value) { alert('Please fill: Date'); return false; }
        if (isFeesOnlyMode()) return true;
        const fields = [ ['channel','Sales channel'], ['product','Product'], ['sa','SA name'], ['area','Selling area'], ['bp-district','District'], ['unitPrice','Unit price'], ['portionWeight','Portion weight'], ['issuedPortions','Stock issued (portions)'], ['closingPortions','Closing balance (portions)'], ['cash','Cash collected'], ['commissionRate','Commission rate'], ['flatRate','Flat wedge'] ];
        for (const [id,label] of fields){ const n = el(id); if (!n || n.value === '' || n.value === null) { alert('Please fill: ' + label); return false; } }
        return true;
      }

      document.getElementById('reset-form').addEventListener('click', () => { form.reset(); setTodaySafe(); commissionRate.value = 20; flatRate.value = 5000; applyChannelDefaults(); applyProductDefaults(); compute(); updateRequired(); });
      document.getElementById('clear-data').addEventListener('click', () => { if(confirm('Clear all saved records?')) { localStorage.setItem(STORAGE_KEY, '[]'); renderTable(); } });
      ;[cash, marketFees, advancedMarketFees].forEach(x => x.addEventListener('input', compute));

      document.getElementById('export-xlsx').addEventListener('click', () => {
        const rows = loadRecords(); if(rows.length === 0) return alert('No data to export');
        const headerMap = { date: 'Date', channel: 'Sales channel', prod: 'Product', sa: 'SA name', area: 'Selling area', district: 'District', price: 'Unit price (UGX)', weight: 'Portion weight (kg)', issuedP: 'Stock issued (portions)', issuedK: 'Stock issued (kg)', closingP: 'Closing balance (portions)', closingK: 'Closing balance (kg)', cashCollected: 'Cash collected (UGX)', actual: 'Actual sales (UGX)', discrepancy: 'Discrepancies (UGX)', rate: 'Commission rate (%)', commission: 'Commission (UGX)', flat: 'Flat wedge (UGX)', totalToPay: 'Total amount to be paid (UGX)', marketFees: 'Market fees (UGX)', advancedMarketFees: 'Advanced market fees (UGX)' };
        const exportRows = rows.map(r => { const o = {}; for (const [k,label] of Object.entries(headerMap)) { o[label] = r[k]; } return o; });
        const ws = XLSX.utils.json_to_sheet(exportRows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'BA payment');
        const pad = (n)=> String(n).padStart(2,'0'); const d = new Date(); const fname = `BA Payment - ${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}.xlsx`;
        XLSX.writeFile(wb, fname);
      });
    })();

    // ======= MARKETING SALES: adapted to BA layout, XLSX only, namespaced IDs =======
    (function Marketing(){
      const PRODUCTS = { "Fresh":{ unitPrice:6000, portionWeight:1.00, mode:"kg" }, "Fried":{ unitPrice:7500, portionWeight:1.00, mode:"kg" }, "Skewers":{ unitPrice:1000, portionWeight:0.06, mode:"portion" }, "Kikalayi":{ unitPrice:500, portionWeight:0.04, mode:"portion" } };
      const $ = (s)=>document.querySelector(s);
      const fmt = n => (Number(n)||0).toLocaleString('en-UG',{maximumFractionDigits:0});
      const num = v => v===''||v==null?0:Number(v);

      const KEY='field-data-records-v1';
      const load = ()=>{ try{return JSON.parse(localStorage.getItem(KEY)||'[]');}catch{return []} };
      const save = (r)=> localStorage.setItem(KEY, JSON.stringify(r));

      function setDefaults(){
        const prod=$('#ms-product').value; const cfg=PRODUCTS[prod];
        $('#ms-unitPrice').value=cfg.unitPrice; $('#ms-portionWeight').value=cfg.portionWeight;
        $('#ms-qtyKg').value=''; $('#ms-qtyPortion').value=''; calc();
      }
      function calc(){
        const prod=$('#ms-product').value, cfg=PRODUCTS[prod];
        const unit= num($('#ms-unitPrice').value||cfg.unitPrice);
        const w =   num($('#ms-portionWeight').value||cfg.portionWeight);
        let qKg=   num($('#ms-qtyKg').value), qP=num($('#ms-qtyPortion').value);
        if(cfg.mode==='kg'){ if(qKg>0){ qP=qKg/w; $('#ms-qtyPortion').value=qP>0?Math.round(qP):''; } $('#ms-qtyKg').disabled=false; $('#ms-qtyPortion').disabled=true; }
        else { if(qP>0){ qKg=qP*w; $('#ms-qtyKg').value=qKg>0?qKg.toFixed(2):''; } $('#ms-qtyKg').disabled=true; $('#ms-qtyPortion').disabled=false; }
        const total=(cfg.mode==='kg'?unit*qKg:unit*qP);
        $('#ms-lineTotal').value=fmt(total); $('#ms-grandTotal').value=fmt(total);
        const paid=num($('#ms-amountPaid').value); $('#ms-balance').value=fmt(Math.max(total-paid,0));
        $('#ms-calcMode').value=(cfg.mode==='kg'?'by kg':'by portion');
        $('#ms-friedWarn').classList.toggle('hidden', prod!=='Fried');
      }

      function setSampleConstraints(){
        const s=$('#ms-sampleProduct').value, kg=$('#ms-sampleQtyKg'), pt=$('#ms-sampleQtyPortion');
        if(!s){ kg.disabled=false; pt.disabled=false; $('#ms-sampleKgHint').textContent='Auto for portion-based products'; $('#ms-samplePortionHint').textContent='Auto for kg-based products'; return; }
        const cfg=PRODUCTS[s];
        if(cfg.mode==='kg'){ kg.disabled=false; pt.disabled=true; pt.value=''; $('#ms-sampleKgHint').textContent='Enter kg (portions auto)'; $('#ms-samplePortionHint').textContent='Auto (kg-based)'; }
        else { kg.disabled=true; kg.value=''; pt.disabled=false; $('#ms-sampleKgHint').textContent='Auto (portion-based)'; $('#ms-samplePortionHint').textContent='Enter portions (kg auto)'; }
        calcSample();
      }
      function calcSample(){
        const s=$('#ms-sampleProduct').value; if(!s) return;
        const w=PRODUCTS[s].portionWeight; let skg=num($('#ms-sampleQtyKg').value), sp=num($('#ms-sampleQtyPortion').value);
        if(PRODUCTS[s].mode==='kg'){ if(skg>0){ sp=skg/w; $('#ms-sampleQtyPortion').value=sp>0?Math.round(sp):''; } }
        else { if(sp>0){ skg=sp*w; $('#ms-sampleQtyKg').value=skg>0?skg.toFixed(2):''; } }
      }

      function buildRow(){
        const prod=$('#ms-product').value, cfg=PRODUCTS[prod];
        const unit=num($('#ms-unitPrice').value||cfg.unitPrice);
        const w=num($('#ms-portionWeight').value||cfg.portionWeight);
        const qKg=num($('#ms-qtyKg').value), qP=num($('#ms-qtyPortion').value);
        const total=(cfg.mode==='kg'?unit*qKg:unit*qP);
        const paid=num($('#ms-amountPaid').value); const bal=Math.max(total-paid,0);
        const sProd=$('#ms-sampleProduct').value||''; const sKg=num($('#ms-sampleQtyKg').value); const sP=num($('#ms-sampleQtyPortion').value);
        return { date:$('#ms-date').value, officer:$('#ms-officer').value.trim(), client:$('#ms-client').value.trim(), district:$('#ms-district').value, area:$('#ms-area').value.trim(), product:prod, calcMode:(cfg.mode==='kg'?'kg':'portion'), unitPrice:unit, portionWeight:w, qtyKg:qKg||0, qtyPortion:qP||0, lineTotal:Math.round(total), payMode:$('#ms-payMode').value, paid:Math.round(paid), balance:Math.round(bal), sampleProduct:sProd, sampleQtyKg:sKg||0, sampleQtyPortion:sP||0 };
      }

      function render(){
        const tb=$('#ms-tableBody'); tb.innerHTML='';
        const rows=load(); rows.forEach((r,i)=>{
          const tr=document.createElement('tr');
          const td=t=>{const d=document.createElement('td'); d.textContent=t; return d;};
          tr.appendChild(td(r.date)); tr.appendChild(td(r.officer)); tr.appendChild(td(r.client));
          tr.appendChild(td(r.district)); tr.appendChild(td(r.area)); tr.appendChild(td(r.product));
          tr.appendChild(td(r.calcMode)); tr.appendChild(td(fmt(r.unitPrice)));
          tr.appendChild(td((r.portionWeight||0).toFixed(2))); tr.appendChild(td((r.qtyKg||0).toFixed(2)));
          tr.appendChild(td(r.qtyPortion||0)); tr.appendChild(td(fmt(r.lineTotal)));
          tr.appendChild(td(r.payMode)); tr.appendChild(td(fmt(r.paid))); tr.appendChild(td(fmt(r.balance)));
          tr.appendChild(td(r.sampleProduct||'')); tr.appendChild(td((r.sampleQtyKg||0).toFixed(2))); tr.appendChild(td(r.sampleQtyPortion||0));
          const a=document.createElement('td'); const b=document.createElement('button'); b.className='btn'; b.textContent='Delete'; b.onclick=()=>{ const rws=load(); rws.splice(i,1); save(rws); render(); }; a.appendChild(b); tr.appendChild(a);
          tb.appendChild(tr);
        });
        const totals=rows.reduce((a,r)=>({total:a.total+r.lineTotal,paid:a.paid+r.paid,bal:a.bal+r.balance}),{total:0,paid:0,bal:0});
        const bar=$('#ms-totalsBar'); bar.innerHTML='';
        const pill = (l,v)=>{ const d=document.createElement('div'); d.className='pill'; d.textContent=`${l}: UGX ${fmt(v)}`; return d; };
        bar.appendChild(pill('Total', totals.total)); bar.appendChild(pill('Paid', totals.paid)); bar.appendChild(pill('Balance', totals.bal));
      }

      function exportXLSX(){
        const rows=load(); if(!rows.length){alert('No data to export.');return;}
        const header=["Date","Officer","Client","District","Area","Product","Calc","Unit UGX","Portion kg","Qty kg","Qty portion","Line Total","Pay Mode","Paid","Balance","Sample Product","Sample Qty (kg)","Sample Qty (portion)"];
        const exportRows = rows.map(r=>({
          [header[0]]:r.date,[header[1]]:r.officer,[header[2]]:r.client,[header[3]]:r.district,[header[4]]:r.area,[header[5]]:r.product,[header[6]]:r.calcMode,[header[7]]:r.unitPrice,[header[8]]:(r.portionWeight||0).toFixed(2),[header[9]]:(r.qtyKg||0).toFixed(2),[header[10]]:r.qtyPortion,[header[11]]:r.lineTotal,[header[12]]:r.payMode,[header[13]]:r.paid,[header[14]]:r.balance,[header[15]]:r.sampleProduct||'',[header[16]]:(r.sampleQtyKg||0).toFixed(2),[header[17]]:r.sampleQtyPortion }));
        const ws = XLSX.utils.json_to_sheet(exportRows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Marketing sales');
        const pad=(n)=> String(n).padStart(2,'0'); const d=new Date(); const fname=`field-data-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}.xlsx`;
        XLSX.writeFile(wb, fname);
      }

      function clearAll(){ if(!confirm('Delete ALL stored data?')) return; localStorage.removeItem(KEY); render(); }
      function clearForm(){ $('#ms-officer').value=''; $('#ms-client').value=''; /* keep locked ms-district as is */ $('#ms-area').value=''; $('#ms-product').value='Fresh'; setDefaults(); $('#ms-amountPaid').value=0; $('#ms-sampleProduct').value=''; $('#ms-sampleQtyKg').value=''; $('#ms-sampleQtyPortion').value=''; setSampleConstraints(); }

      // Events
      (function init(){
        document.getElementById('ms-date').value=todayISO(); setDefaults(); setSampleConstraints(); calc(); render();
        document.getElementById('ms-product').addEventListener('change', setDefaults);
        ['#ms-unitPrice','#ms-portionWeight','#ms-qtyKg','#ms-qtyPortion','#ms-amountPaid'].forEach(s=>$(s).addEventListener('input', calc));
        document.getElementById('ms-sampleProduct').addEventListener('change', setSampleConstraints);
        document.getElementById('ms-sampleQtyKg').addEventListener('input', calcSample);
        document.getElementById('ms-sampleQtyPortion').addEventListener('input', calcSample);
        document.getElementById('ms-addBtn').addEventListener('click', (e)=>{ e.preventDefault(); if(!$('#ms-officer').value.trim()||!$('#ms-client').value.trim()){ alert('Please fill: Channel officer name, Client name'); return; } const r=load(); r.push(buildRow()); save(r); render(); clearForm(); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); });
        document.getElementById('ms-clearAllBtn').addEventListener('click', (e)=>{ e.preventDefault(); clearAll(); });
        document.getElementById('ms-exportXlsxBtn').addEventListener('click', (e)=>{ e.preventDefault(); exportXLSX(); });
        document.getElementById('ms-clearFormBtn').addEventListener('click', (e)=>{ e.preventDefault(); clearForm(); });
      })();
    })();
  </script>
</body>
</html>
